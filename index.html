<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–ù–∞–π–¥–∏ —Å–≤–æ—é –¥–∏–∑–∞–π–Ω-–ø—Ä–æ—Ñ–µ—Å—Å–∏—é</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
@font-face { font-family:'PPNeueMachina'; src:url('https://design.synergy.ru/fonts/PPNeueMachina-Ultrabold.woff2') format('woff2'); font-weight:800; }
@font-face { font-family:'Gilroy'; src:url('https://design.synergy.ru/fonts/Gilroy-Semibold.woff2') format('woff2'); font-weight:600; }
@font-face { font-family:'Gilroy'; src:url('https://design.synergy.ru/fonts/Gilroy-Bold.woff2') format('woff2'); font-weight:700; }

*{margin:0;padding:0;box-sizing:border-box}
:root{
  --dark:#222222; --surface:#2a2a2a; --surface2:#333; --border:rgba(255,255,255,0.12);
  --white:#fff; --muted:#868686; --cyan:#00e5ff; --purple:#b388ff;
  --green:#4ade80; --amber:#fbbf24; --pink:#ff6b9d; --red:#c8102e;
  --line:rgba(255,255,255,0.15); --muted2:#868686;
}
body{font-family:'Gilroy','Helvetica Neue',sans-serif;background:var(--dark);color:var(--white);min-height:100vh;overflow-x:hidden;font-weight:600}

.screen{display:none;padding:48px 20px;max-width:860px;margin:0 auto;animation:fadeIn .5s ease}
.screen.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}

.progress-bar{position:fixed;top:0;left:0;height:3px;background:linear-gradient(90deg,var(--cyan),var(--purple));transition:width .5s;z-index:100}

/* XP HUD */
.xp-hud{position:fixed;top:12px;right:16px;z-index:101;display:flex;align-items:center;gap:12px;background:rgba(34,34,34,0.92);backdrop-filter:blur(12px);border:1px solid var(--border);border-radius:77px;padding:6px 16px 6px 10px;opacity:0;transform:translateY(-20px);transition:all .5s ease;pointer-events:none}
.xp-hud.visible{opacity:1;transform:translateY(0);pointer-events:auto}
.xp-hud-lvl{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'PPNeueMachina',sans-serif;font-weight:800;font-size:14px;background:linear-gradient(135deg,var(--cyan),var(--purple));color:var(--dark);flex-shrink:0}
.xp-hud-info{display:flex;flex-direction:column;gap:2px}
.xp-hud-name{font-size:12px;font-weight:700;color:var(--white);line-height:1}
.xp-hud-bar{width:100px;height:4px;background:rgba(255,255,255,0.1);border-radius:2px;overflow:hidden}
.xp-hud-fill{height:100%;background:linear-gradient(90deg,var(--cyan),var(--purple));border-radius:2px;transition:width .8s cubic-bezier(.4,0,.2,1);width:0}
.xp-hud-xp{font-size:12px;font-family:'PPNeueMachina',sans-serif;font-weight:800;color:var(--cyan);line-height:1}

/* XP popup */
.xp-popup{position:fixed;top:50%;left:50%;z-index:102;background:rgba(34,34,34,0.97);backdrop-filter:blur(16px);border:1px solid var(--cyan);border-radius:20px;padding:28px 36px;opacity:0;transform:translate(-50%,-50%) scale(0.9);transition:all .4s cubic-bezier(.4,0,.2,1);pointer-events:none;min-width:280px;text-align:center;box-shadow:0 0 60px rgba(0,229,255,0.12)}
.xp-popup.show{opacity:1;transform:translate(-50%,-50%) scale(1)}
.xp-popup-title{font-family:'PPNeueMachina',sans-serif;font-weight:800;font-size:12px;letter-spacing:2px;text-transform:uppercase;color:var(--cyan);margin-bottom:8px}
.xp-popup-xp{font-family:'PPNeueMachina',sans-serif;font-weight:800;font-size:22px;color:var(--white);margin-bottom:4px}
.xp-popup-ach{font-size:13px;color:var(--amber);margin-top:6px}
.xp-popup-acc{font-family:'PPNeueMachina',sans-serif;font-weight:800;font-size:15px;color:var(--white);margin-bottom:6px}
.xp-popup-acc-bar{width:100%;height:6px;background:rgba(255,255,255,0.1);border-radius:3px;overflow:hidden;margin-bottom:10px}
.xp-popup-acc-fill{height:100%;border-radius:3px;transition:width 1s cubic-bezier(.4,0,.2,1);width:0}
.xp-popup-lvlup{font-family:'PPNeueMachina',sans-serif;font-weight:800;font-size:14px;color:var(--green);margin-top:6px;animation:lvlPulse 1s ease infinite alternate}
@keyframes lvlPulse{from{opacity:.7}to{opacity:1}}

.module-tag{display:inline-block;font-family:'PPNeueMachina',sans-serif;font-weight:800;font-size:12px;letter-spacing:2px;text-transform:uppercase;color:var(--cyan);background:rgba(0,229,255,0.1);padding:6px 16px;border-radius:77px;margin-bottom:14px}
.module-title{font-family:'PPNeueMachina',sans-serif;font-weight:800;font-size:clamp(1.5rem,4vw,2.2rem);text-transform:uppercase;margin-bottom:8px}
.module-desc{color:var(--muted);font-size:.95rem;line-height:1.6;margin-bottom:28px}

.btn{display:inline-flex;align-items:center;gap:8px;padding:14px 32px;border-radius:77px;border:1.5px solid var(--cyan);background:transparent;color:var(--white);font-family:'Gilroy',sans-serif;font-size:14px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;cursor:pointer;transition:all .3s}
.btn:hover{background:var(--cyan);color:var(--dark)}
.btn:disabled{opacity:.3;cursor:not-allowed;background:transparent;color:var(--white)}
.btn-row{display:flex;justify-content:flex-end;margin-top:32px}

/* WELCOME */
.welcome-title{font-family:'PPNeueMachina',sans-serif;font-weight:800;font-size:clamp(2.2rem,6vw,4rem);text-transform:uppercase;line-height:1;margin-bottom:20px}
.welcome-title .hl{background:linear-gradient(135deg,var(--cyan),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.welcome-sub{font-size:1.05rem;color:var(--muted);line-height:1.7;margin-bottom:36px;max-width:560px}
.welcome-meta{display:flex;gap:24px;margin-bottom:40px;flex-wrap:wrap}
.welcome-meta span{font-size:14px;color:var(--muted);display:flex;align-items:center;gap:6px}

/* CARDS */
.card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;margin-top:20px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;cursor:pointer;transition:all .3s;position:relative}
.card:hover{border-color:var(--cyan);transform:translateY(-2px)}
.card.selected{border-color:var(--cyan);background:rgba(0,229,255,0.06);box-shadow:0 0 20px rgba(0,229,255,0.08)}
.card .emoji{font-size:1.5rem;margin-bottom:8px}
.card .label{font-weight:700;font-size:.95rem}
.card .hint{font-size:13px;color:var(--muted);margin-top:4px}

/* KERNING */
.kerning-workspace{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:48px 20px;text-align:center;margin-top:20px}
.kerning-word{display:inline-flex;align-items:baseline;font-family:'PPNeueMachina',sans-serif;font-size:clamp(3rem,9vw,5.5rem);font-weight:800;user-select:none}
.kerning-letter{position:relative;cursor:grab;transition:color .2s;padding:0 2px}
.kerning-letter.dragging{color:var(--cyan);cursor:grabbing}
.kerning-letter.fixed{cursor:default;color:var(--muted)}
.kerning-hint{margin-top:20px;font-size:14px;color:var(--muted)}

/* CHOICE */
.choice-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:16px;margin-top:20px}
.choice-card{background:var(--surface);border:2px solid var(--border);border-radius:14px;overflow:hidden;cursor:pointer;transition:all .3s}
.choice-card:hover{border-color:var(--cyan);transform:translateY(-2px)}
.choice-card.selected{border-color:var(--green);box-shadow:0 0 16px rgba(74,222,128,0.15)}
.choice-img{width:100%;aspect-ratio:4/3;background:var(--surface2);display:flex;align-items:center;justify-content:center;font-size:3rem}
.choice-label{padding:14px;font-weight:600;font-size:14px;text-align:center}

/* ARGUMENT */
.arg-grid{display:grid;gap:10px;margin-top:16px}
.arg-chip{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px 18px;cursor:pointer;font-size:14px;transition:all .3s}
.arg-chip:hover{border-color:var(--cyan)}
.arg-chip.selected{border-color:var(--amber);background:rgba(251,191,36,0.08)}

/* CASE */
.case-brief{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:24px;margin:20px 0}
.brief-label{font-family:'PPNeueMachina',sans-serif;font-size:12px;font-weight:800;letter-spacing:2px;text-transform:uppercase;color:var(--amber);margin-bottom:8px}
.case-options{display:flex;flex-direction:column;gap:10px;margin-top:16px}
.case-opt{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px 20px;cursor:pointer;transition:all .3s;display:flex;align-items:center;gap:14px}
.case-opt:hover{border-color:var(--cyan)}
.case-opt.selected{border-color:var(--green);background:rgba(74,222,128,0.06)}
.case-opt .opt-icon{font-size:1.4rem}
.case-opt .opt-text{font-size:14px}

/* DRAWING */
.draw-workspace{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:20px;margin-top:20px;text-align:center}
.draw-toolbar{display:flex;gap:8px;justify-content:center;margin-bottom:16px;flex-wrap:wrap}
.draw-toolbar button{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:8px 14px;color:var(--white);font-family:'Gilroy',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .3s}
.draw-toolbar button:hover,.draw-toolbar button.active{border-color:var(--cyan);color:var(--cyan)}
.draw-canvas{border:1px solid var(--border);border-radius:8px;cursor:crosshair;background:#1a1a1a;display:block;margin:0 auto;width:100%;max-width:600px;touch-action:none}

/* ASSEMBLY (pointer-based for mobile) */
.assembly-area{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px}
.assembly-palette{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:16px}
.assembly-palette-title{font-size:12px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:12px}
.assembly-blocks{display:flex;flex-direction:column;gap:8px}
.assembly-block{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px 16px;cursor:pointer;transition:all .2s;font-size:14px;display:flex;align-items:center;gap:10px;user-select:none}
.assembly-block:hover{border-color:var(--cyan)}
.assembly-canvas{background:var(--surface);border:2px dashed var(--border);border-radius:14px;padding:16px;min-height:300px;display:flex;flex-direction:column;gap:8px;transition:border-color .3s}
.assembly-canvas.over{border-color:var(--cyan)}
.assembly-canvas-title{font-size:12px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:8px}
.assembly-slot{background:rgba(0,229,255,0.04);border:1px solid var(--border);border-radius:8px;padding:12px 16px;font-size:14px;display:flex;align-items:center;gap:10px;cursor:pointer;transition:all .2s}
.assembly-slot:hover{border-color:var(--pink)}
.assembly-slot .remove{margin-left:auto;color:var(--muted);cursor:pointer;font-size:16px}

/* COLOR */
.color-options{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:14px;margin-top:20px}
.color-opt{border:2px solid var(--border);border-radius:14px;overflow:hidden;cursor:pointer;transition:all .3s}
.color-opt:hover{border-color:var(--cyan);transform:translateY(-2px)}
.color-opt.selected{border-color:var(--green);box-shadow:0 0 16px rgba(74,222,128,0.15)}
.color-swatches{display:flex;height:80px}
.color-swatches div{flex:1}
.color-opt-label{padding:12px;font-size:13px;text-align:center;font-weight:600}

/* FONT */
.font-pairs{display:flex;flex-direction:column;gap:14px;margin-top:20px}
.font-pair{display:grid;grid-template-columns:1fr 1fr;gap:2px;border:2px solid var(--border);border-radius:14px;overflow:hidden;cursor:pointer;transition:all .3s}
.font-pair:hover{border-color:var(--cyan)}
.font-pair.selected{border-color:var(--green);box-shadow:0 0 16px rgba(74,222,128,0.15)}
.font-left{background:var(--surface);padding:20px;display:flex;align-items:center;justify-content:center}
.font-right{background:var(--surface2);padding:20px;display:flex;flex-direction:column;justify-content:center;gap:4px}
.font-sample{line-height:1.3}
.font-name{font-size:12px;color:var(--muted);margin-top:4px}

/* SPOT ERROR */
.spot-workspace{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:32px;margin-top:20px;display:flex;flex-wrap:wrap;gap:14px;justify-content:center}
.spot-item{border:2px solid var(--border);border-radius:10px;padding:16px 24px;cursor:pointer;transition:all .3s;font-size:15px;text-align:center;min-width:120px}
.spot-item:hover{border-color:var(--cyan)}
.spot-item.selected{border-color:var(--pink);background:rgba(255,107,157,0.08)}

/* PROPORTION */
.proportion-workspace{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:32px 20px;margin-top:20px;text-align:center}
.proportion-canvas{display:block;margin:0 auto;border:1px solid var(--border);border-radius:8px;cursor:ew-resize;touch-action:none;width:100%;max-width:560px}
.proportion-hint{font-size:14px;color:var(--muted);margin-top:16px}
.proportion-value{font-family:'PPNeueMachina',sans-serif;font-size:20px;margin-top:8px;color:var(--cyan)}

/* ===== RESULTS PAGE STYLES ===== */
.results-container{max-width:1280px;margin:0 auto;padding:0 20px}
.hero{background:var(--dark);color:var(--white);padding:60px 0 40px;position:relative;overflow:hidden}
.hero-inner{display:flex;align-items:flex-start;justify-content:space-between;gap:40px;position:relative;z-index:1}
.hero-left{flex:1}
.hero-class{font-family:'PPNeueMachina','Arial Black',sans-serif;font-weight:800;font-size:clamp(2rem,6vw,4rem);text-transform:uppercase;line-height:1.0;letter-spacing:-0.02em;margin-bottom:28px}
.hero-class .highlight{background:linear-gradient(135deg,var(--cyan),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.hero-desc{font-size:1rem;line-height:1.7;color:var(--muted2);max-width:520px;font-weight:600}
.hero-right{display:flex;flex-direction:column;align-items:flex-end;gap:16px;flex-shrink:0}
.hero-icon{width:100px;height:100px;display:flex;align-items:center;justify-content:center;font-size:2.5rem;background:linear-gradient(135deg,rgba(0,229,255,0.1),rgba(179,136,255,0.1));border:2px solid rgba(0,229,255,0.3);border-radius:50%;animation:iconPulse 3s ease-in-out infinite}
@keyframes iconPulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.04);opacity:.8}}

.divider{border:none;border-top:1px solid var(--line);margin:0}
.level-section{padding:40px 0}
.level-grid{display:flex;align-items:center;gap:24px;flex-wrap:wrap}
.lvl-badge{font-family:'PPNeueMachina',sans-serif;font-weight:800;font-size:3.5rem;line-height:1;background:linear-gradient(135deg,var(--cyan),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.lvl-badge span{display:block;font-size:12px;letter-spacing:3px;opacity:.5;margin-top:4px;-webkit-text-fill-color:var(--muted2)}
.lvl-info{flex:1;min-width:140px}
.lvl-name{font-family:'PPNeueMachina',sans-serif;font-weight:800;font-size:1.1rem;text-transform:uppercase;margin-bottom:6px}
.lvl-sub{font-size:.9rem;color:rgba(255,255,255,0.3)}
.xp-area{min-width:200px;flex:1}
.xp-meta{font-size:12px;color:var(--muted2);margin-bottom:8px;display:flex;justify-content:space-between;text-transform:uppercase;letter-spacing:1px}
.xp-bar{height:6px;background:rgba(255,255,255,0.08);border-radius:3px;overflow:hidden}
.xp-fill{height:100%;border-radius:3px;width:0;background:linear-gradient(90deg,var(--cyan),var(--purple));transition:width 1.5s cubic-bezier(.22,1,.36,1)}
.lvl-scale{width:100%;margin-top:20px}
.lvl-pips{display:flex;gap:4px}
.lvl-pip{height:5px;flex:1;border-radius:3px;background:rgba(255,255,255,0.08)}
.lvl-pip.filled{background:linear-gradient(90deg,var(--cyan),var(--purple))}
.lvl-pip.current{background:var(--pink);box-shadow:0 0 8px rgba(255,107,157,0.4)}
.lvl-labels{display:flex;justify-content:space-between;margin-top:8px}
.lvl-labels span{font-size:12px;color:var(--muted2);text-transform:uppercase;letter-spacing:1px}

.section{padding:40px 0}
.section-title{font-family:'PPNeueMachina',sans-serif;font-weight:800;font-size:clamp(1.4rem,4vw,2.2rem);text-transform:uppercase;margin-bottom:32px;letter-spacing:-0.01em}
.section-label{font-size:12px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(--cyan);margin-bottom:14px}

.radar-grid{display:grid;grid-template-columns:1fr 1fr;gap:24px}
.radar-card{text-align:center;position:relative}
.radar-card h3{font-family:'PPNeueMachina',sans-serif;font-weight:800;font-size:12px;letter-spacing:2px;text-transform:uppercase;color:var(--muted2);margin-bottom:16px}
.radar-card canvas{max-width:100%;height:auto}

.flow-card{overflow-x:auto;-webkit-overflow-scrolling:touch}
.flow-canvas-wrap{position:relative;min-width:1200px}
#flowCanvas{display:block;width:100%}

.demand-grid{display:grid;grid-template-columns:1fr 1fr;gap:32px}
.demand-col-label{font-family:'PPNeueMachina',sans-serif;font-weight:800;font-size:12px;letter-spacing:2px;text-transform:uppercase;color:var(--muted2);margin-bottom:24px;padding-bottom:14px;border-bottom:1px solid var(--line)}
.d-card{border:1px solid var(--line);border-radius:0;padding:24px;margin-bottom:16px;transition:all .3s;position:relative;overflow:hidden}
.d-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--cyan),var(--purple),transparent);opacity:0;transition:opacity .3s}
.d-card:hover{border-color:rgba(0,229,255,0.3)}
.d-card:hover::before{opacity:1}
.d-head{display:flex;align-items:center;gap:12px;margin-bottom:16px}
.d-icon{font-size:1.4rem}
.d-title{font-family:'PPNeueMachina',sans-serif;font-weight:800;font-size:.9rem;text-transform:uppercase}
.d-metrics{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px}
.d-m{text-align:center;padding:12px 4px;border:1px solid var(--line)}
.d-m-val{font-family:'PPNeueMachina',sans-serif;font-weight:800;font-size:1rem}
.d-m-val.hot{color:var(--green)}
.d-m-val.warm{color:var(--amber)}
.d-m-label{font-size:12px;color:var(--muted2);margin-top:4px;text-transform:uppercase;letter-spacing:.5px}
.d-chart{height:150px;position:relative;border:1px solid var(--line);padding:24px 16px;margin-bottom:16px}
.d-chart canvas{width:100%!important;height:100%!important}
.d-chips{display:flex;flex-wrap:wrap;gap:6px}
.d-chip{font-size:12px;padding:6px 14px;border-radius:77px;border:1px solid var(--line);color:var(--muted2);text-transform:uppercase;letter-spacing:.5px}
.d-trend{display:inline-flex;align-items:center;gap:4px;font-size:12px;padding:5px 14px;border-radius:77px;margin-top:12px;font-weight:700;text-transform:uppercase;letter-spacing:1px;border:1px solid}
.d-trend.up{border-color:var(--green);color:var(--green)}

.ach-row{display:flex;flex-wrap:wrap;gap:10px;margin-top:20px}
.ach-item{display:flex;align-items:center;gap:8px;background:rgba(0,229,255,0.06);border:1px solid rgba(0,229,255,0.2);border-radius:77px;padding:8px 18px;font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:1px}

.share-section{text-align:center;padding:48px 0}
.share-title{font-family:'PPNeueMachina',sans-serif;font-weight:800;font-size:clamp(1.2rem,3vw,1.8rem);text-transform:uppercase;margin-bottom:24px}
.btn-pill{display:inline-flex;align-items:center;gap:8px;padding:14px 32px;border-radius:77px;border:1.5px solid var(--cyan);background:transparent;color:var(--white);font-family:'Gilroy',sans-serif;font-size:14px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;cursor:pointer;transition:all .3s;text-decoration:none}
.btn-pill:hover{background:var(--cyan);color:var(--dark)}

.reveal{opacity:0;transform:translateY(24px);transition:opacity .6s cubic-bezier(.22,1,.36,1),transform .6s cubic-bezier(.22,1,.36,1)}
.reveal.visible{opacity:1;transform:translateY(0)}

/* RESPONSIVE */
@media(max-width:600px){
  .screen{padding:24px 16px}
  .card-grid{grid-template-columns:1fr 1fr}
  .assembly-area{grid-template-columns:1fr}
  .radar-grid{grid-template-columns:1fr}
  .demand-grid{grid-template-columns:1fr}
  .hero-inner{flex-direction:column}
  .hero-right{align-items:flex-start}
  .level-grid{gap:16px}
  .color-options{grid-template-columns:1fr 1fr}
}
</style>
</head>
<body>

<div class="progress-bar" id="progressBar"></div>

<div class="xp-hud" id="xpHud">
  <div class="xp-hud-lvl" id="hudLvl">1</div>
  <div class="xp-hud-info">
    <div class="xp-hud-name" id="hudName">–ù–æ–≤–∏—á–æ–∫</div>
    <div class="xp-hud-bar"><div class="xp-hud-fill" id="hudFill"></div></div>
  </div>
  <div class="xp-hud-xp" id="hudXp">0 XP</div>
</div>

<div class="xp-popup" id="xpPopup">
  <div class="xp-popup-title">–ú–æ–¥—É–ª—å –ø—Ä–æ–π–¥–µ–Ω!</div>
  <div class="xp-popup-acc" id="popupAcc"></div>
  <div class="xp-popup-acc-bar" id="popupAccBar" style="display:none"><div class="xp-popup-acc-fill" id="popupAccFill"></div></div>
  <div class="xp-popup-xp" id="popupXp">+0 XP</div>
  <div class="xp-popup-ach" id="popupAch"></div>
  <div class="xp-popup-lvlup" id="popupLvl" style="display:none">‚¨Ü –£–†–û–í–ï–ù–¨ –ü–û–í–´–®–ï–ù!</div>
</div>

<!-- SCREEN: WELCOME -->
<div class="screen active" id="screen-welcome">
  <div style="padding-top:40px">
    <div class="welcome-title"><span class="hl">–ù–∞–π–¥–∏ —Å–≤–æ—é</span><br>–¥–∏–∑–∞–π–Ω-–ø—Ä–æ—Ñ–µ—Å—Å–∏—é</div>
    <div class="welcome-sub">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ç–µ—Å—Ç –∏–∑ 10 –º–æ–¥—É–ª–µ–π: –∫–µ—Ä–Ω–∏–Ω–≥, –∫–µ–π—Å—ã, —Ä–∏—Å–æ–≤–∞–Ω–∏–µ, –∫–æ–º–ø–æ–∑–∏—Ü–∏—è, —Ü–≤–µ—Ç ‚Äî —É–∑–Ω–∞–π, –∫–∞–∫–∞—è –¥–∏–∑–∞–π–Ω-—Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å —Ç–µ–±–µ –ø–æ–¥—Ö–æ–¥–∏—Ç.</div>
    <div class="welcome-meta">
      <span>‚è± ~10 –º–∏–Ω—É—Ç</span><span>üéÆ 10 –º–æ–¥—É–ª–µ–π</span><span>üìä –ü–æ–¥—Ä–æ–±–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å</span>
    </div>
    <button class="btn" onclick="go('screen-edu')">–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç ‚Üí</button>
  </div>
</div>

<!-- SCREEN: EDUCATION -->
<div class="screen" id="screen-edu">
  <div class="module-tag">–®–∞–≥ 0</div>
  <div class="module-title">–¢–≤–æ—ë –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</div>
  <div class="module-desc">–ù—É–∂–Ω–æ, —á—Ç–æ–±—ã –ø–æ–¥–æ–±—Ä–∞—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã</div>
  <div class="card-grid" id="eduGrid">
    <div class="card" data-v="9class" onclick="selectCard(this,'edu')"><div class="emoji">üìö</div><div class="label">9 –∫–ª–∞—Å—Å–æ–≤</div><div class="hint">–£—á—É—Å—å –∏–ª–∏ –æ–∫–æ–Ω—á–∏–ª(–∞)</div></div>
    <div class="card" data-v="11class" onclick="selectCard(this,'edu')"><div class="emoji">üéì</div><div class="label">11 –∫–ª–∞—Å—Å–æ–≤</div><div class="hint">–£—á—É—Å—å –∏–ª–∏ –æ–∫–æ–Ω—á–∏–ª(–∞)</div></div>
    <div class="card" data-v="spo" onclick="selectCard(this,'edu')"><div class="emoji">üõ†</div><div class="label">–ö–æ–ª–ª–µ–¥–∂ / –°–ü–û</div><div class="hint">–°—Ä–µ–¥–Ω–µ–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ</div></div>
    <div class="card" data-v="bachelor" onclick="selectCard(this,'edu')"><div class="emoji">üèõ</div><div class="label">–ë–∞–∫–∞–ª–∞–≤—Ä–∏–∞—Ç</div><div class="hint">–û–∫–æ–Ω—á–∏–ª(–∞) –∏–ª–∏ —É—á—É—Å—å</div></div>
    <div class="card" data-v="master" onclick="selectCard(this,'edu')"><div class="emoji">üî¨</div><div class="label">–ú–∞–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä–∞</div><div class="hint">–û–∫–æ–Ω—á–∏–ª(–∞) –∏–ª–∏ —É—á—É—Å—å</div></div>
  </div>
  <div class="btn-row"><button class="btn" id="eduNext" disabled onclick="go('screen-kerning')">–î–∞–ª–µ–µ ‚Üí</button></div>
</div>

<div class="screen" id="screen-kerning">
  <div class="module-tag">–ú–æ–¥—É–ª—å 1 ¬∑ –¢–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞</div>
  <div class="module-title">–ù–∞—Å—Ç—Ä–æ–π –∫–µ—Ä–Ω–∏–Ω–≥</div>
  <div class="module-desc">–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π –±—É–∫–≤—ã, —á—Ç–æ–±—ã —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –≤—ã–≥–ª—è–¥–µ–ª–∏ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ</div>
  <div class="kerning-workspace"><div class="kerning-word" id="kerningWord"></div><div class="kerning-hint">‚Üê —Ç—è–Ω–∏ –±—É–∫–≤—ã –≤–ª–µ–≤–æ-–≤–ø—Ä–∞–≤–æ ‚Üí</div></div>
  <div class="btn-row"><button class="btn" onclick="finishKerning()">–ì–æ—Ç–æ–≤–æ ‚Üí</button></div>
</div>

<div class="screen" id="screen-choice">
  <div class="module-tag">–ú–æ–¥—É–ª—å 2 ¬∑ –ù–∞—Å–º–æ—Ç—Ä–µ–Ω–Ω–æ—Å—Ç—å</div>
  <div class="module-title">–ö–∞–∫–æ–π –ª–æ–≥–æ—Ç–∏–ø –ª—É—á—à–µ?</div>
  <div class="module-desc">–ö–æ—Ñ–µ–π–Ω—è –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ ‚Äî –≤—ã–±–µ—Ä–∏ –Ω–∞–∏–±–æ–ª–µ–µ —É–¥–∞—á–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç</div>
  <div class="choice-grid" id="choiceGrid"></div>
  <div id="argSection" style="display:none;margin-top:24px">
    <div style="font-weight:700;margin-bottom:10px;font-size:14px;text-transform:uppercase;letter-spacing:1px;color:var(--muted)">–ü–æ—á–µ–º—É —ç—Ç–æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç –ª—É—á—à–µ?</div>
    <div class="arg-grid" id="argGrid"></div>
  </div>
  <div class="btn-row"><button class="btn" id="choiceNext" disabled onclick="finishChoice()">–î–∞–ª–µ–µ ‚Üí</button></div>
</div>

<div class="screen" id="screen-case">
  <div class="module-tag">–ú–æ–¥—É–ª—å 3 ¬∑ –ö–µ–π—Å</div>
  <div class="module-title">–†–µ—à–∏ –±—Ä–∏—Ñ</div>
  <div class="module-desc">–ü—Ä–æ—á–∏—Ç–∞–π –∑–∞–¥–∞—á—É –∏ –≤—ã–±–µ—Ä–∏, —Å —á–µ–≥–æ –Ω–∞—á–Ω—ë—à—å</div>
  <div class="case-brief"><div class="brief-label">–ë—Ä–∏—Ñ</div><div class="brief-text">–ì–æ—Ä–æ–¥—Å–∫–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Ö–æ—á–µ—Ç –ø—Ä–∏–≤–ª–µ—á—å –ø–æ–¥—Ä–æ—Å—Ç–∫–æ–≤. –°–µ–π—á–∞—Å –æ–Ω–∏ –≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞—é—Ç –µ—ë –∫–∞–∫ —Å–∫—É—á–Ω–æ–µ –º–µ—Å—Ç–æ. –ë—é–¥–∂–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω.</div></div>
  <div class="case-options" id="caseOpts"></div>
  <div class="btn-row"><button class="btn" id="caseNext" disabled onclick="finishCase()">–î–∞–ª–µ–µ ‚Üí</button></div>
</div>

<div class="screen" id="screen-draw">
  <div class="module-tag">–ú–æ–¥—É–ª—å 4 ¬∑ –†–∏—Å–æ–≤–∞–Ω–∏–µ</div>
  <div class="module-title">–ù–∞—Ä–∏—Å—É–π –ª–æ–≥–æ—Ç–∏–ø</div>
  <div class="module-desc">–ö–æ—Ñ–µ–π–Ω—è ¬´–ó–µ—Ä–Ω–æ¬ª ‚Äî –Ω–∞—Ä–∏—Å—É–π –ø—Ä–æ—Å—Ç–æ–π –∑–Ω–∞–∫, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–¥–∞—ë—Ç —Å—É—Ç—å –±—Ä–µ–Ω–¥–∞</div>
  <div class="draw-workspace">
    <div class="draw-toolbar" id="drawToolbar">
      <button class="active" onclick="setDrawColor('#ffffff',this)">‚ö™</button>
      <button onclick="setDrawColor('#00e5ff',this)">üîµ</button>
      <button onclick="setDrawColor('#ff6b9d',this)">üî¥</button>
      <button onclick="setDrawColor('#fbbf24',this)">üü°</button>
      <button onclick="setDrawSize(3,this)" data-group="size" class="active">–¢–æ–Ω–∫–∞—è</button>
      <button onclick="setDrawSize(8,this)" data-group="size">–¢–æ–ª—Å—Ç–∞—è</button>
      <button onclick="clearDrawCanvas()">‚úï</button>
    </div>
    <canvas class="draw-canvas" id="drawCanvas"></canvas>
  </div>
  <div class="btn-row"><button class="btn" onclick="finishDraw()">–î–∞–ª–µ–µ ‚Üí</button></div>
</div>

<div class="screen" id="screen-assembly">
  <div class="module-tag">–ú–æ–¥—É–ª—å 5 ¬∑ –ö–æ–º–ø–æ–∑–∏—Ü–∏—è</div>
  <div class="module-title">–°–æ–±–µ—Ä–∏ –º–∞–∫–µ—Ç</div>
  <div class="module-desc">–ù–∞–∂–º–∏ –Ω–∞ –±–ª–æ–∫–∏, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∏—Ö –≤ –º–∞–∫–µ—Ç –≤ –Ω—É–∂–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ</div>
  <div class="assembly-area">
    <div class="assembly-palette"><div class="assembly-palette-title">–ë–ª–æ–∫–∏</div><div class="assembly-blocks" id="asmBlocks"></div></div>
    <div class="assembly-canvas" id="asmCanvas"><div class="assembly-canvas-title">–ú–∞–∫–µ—Ç –ª–µ–Ω–¥–∏–Ω–≥–∞</div></div>
  </div>
  <div class="btn-row"><button class="btn" onclick="finishAssembly()">–î–∞–ª–µ–µ ‚Üí</button></div>
</div>

<div class="screen" id="screen-color">
  <div class="module-tag">–ú–æ–¥—É–ª—å 6 ¬∑ –¶–≤–µ—Ç</div>
  <div class="module-title">–í—ã–±–µ—Ä–∏ –ø–∞–ª–∏—Ç—Ä—É</div>
  <div class="module-desc">–ö–∞–∫–∞—è —Ü–≤–µ—Ç–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞ –ª—É—á—à–µ –≤—Å–µ–≥–æ –ø–æ–¥–æ–π–¥—ë—Ç –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –º–µ–¥–∏—Ç–∞—Ü–∏–∏?</div>
  <div class="color-options" id="colorOpts"></div>
  <div class="btn-row"><button class="btn" id="colorNext" disabled onclick="finishColor()">–î–∞–ª–µ–µ ‚Üí</button></div>
</div>

<div class="screen" id="screen-font">
  <div class="module-tag">–ú–æ–¥—É–ª—å 7 ¬∑ –®—Ä–∏—Ñ—Ç—ã</div>
  <div class="module-title">–ü–æ–¥–±–µ—Ä–∏ —à—Ä–∏—Ñ—Ç</div>
  <div class="module-desc">–ö–∞–∫–∞—è –ø–∞—Ä–∞ —à—Ä–∏—Ñ—Ç–æ–≤ –ª—É—á—à–µ –ø–æ–¥–æ–π–¥—ë—Ç –¥–ª—è —Å–∞–π—Ç–∞ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π —Ñ–∏—Ä–º—ã?</div>
  <div class="font-pairs" id="fontPairs"></div>
  <div class="btn-row"><button class="btn" id="fontNext" disabled onclick="finishFont()">–î–∞–ª–µ–µ ‚Üí</button></div>
</div>

<div class="screen" id="screen-spot">
  <div class="module-tag">–ú–æ–¥—É–ª—å 8 ¬∑ –í–Ω–∏–º–∞–Ω–∏–µ –∫ –¥–µ—Ç–∞–ª—è–º</div>
  <div class="module-title">–ù–∞–π–¥–∏ –æ—à–∏–±–∫—É</div>
  <div class="module-desc">–í —ç—Ç–æ–º –Ω–∞–±–æ—Ä–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –æ–¥–Ω–∞ –≤–µ—â—å –Ω–∞—Ä—É—à–∞–µ—Ç –≤–∏–∑—É–∞–ª—å–Ω—É—é –≥–∞—Ä–º–æ–Ω–∏—é. –ù–∞–∂–º–∏ –Ω–∞ –Ω–µ—ë.</div>
  <div class="spot-workspace" id="spotItems"></div>
  <div class="btn-row"><button class="btn" id="spotNext" disabled onclick="finishSpot()">–î–∞–ª–µ–µ ‚Üí</button></div>
</div>

<div class="screen" id="screen-proportion">
  <div class="module-tag">–ú–æ–¥—É–ª—å 9 ¬∑ –ü—Ä–æ–ø–æ—Ä—Ü–∏–∏</div>
  <div class="module-title">–ù–∞–π–¥–∏ –∑–æ–ª–æ—Ç–æ–µ —Å–µ—á–µ–Ω–∏–µ</div>
  <div class="module-desc">–î–≤–∏–≥–∞–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –∏–¥–µ–∞–ª—å–Ω—É—é –ø—Ä–æ–ø–æ—Ä—Ü–∏—é –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞</div>
  <div class="proportion-workspace">
    <canvas class="proportion-canvas" id="propCanvas"></canvas>
    <div class="proportion-value" id="propValue">50 : 50</div>
    <div class="proportion-hint">‚Üê –¥–≤–∏–≥–∞–π ‚Üí</div>
  </div>
  <div class="btn-row"><button class="btn" onclick="finishProportion()">–î–∞–ª–µ–µ ‚Üí</button></div>
</div>

<div class="screen" id="screen-dream">
  <div class="module-tag">–ú–æ–¥—É–ª—å 10 ¬∑ –ú–µ—á—Ç–∞</div>
  <div class="module-title">–ü—Ä–æ–µ–∫—Ç –º–µ—á—Ç—ã</div>
  <div class="module-desc">–ü–æ–ª–Ω–∞—è —Å–≤–æ–±–æ–¥–∞! –í—ã–±–µ—Ä–∏ 2 –ø—Ä–æ–µ–∫—Ç–∞, –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—á–µ—Ç—Å—è —Å–¥–µ–ª–∞—Ç—å –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ</div>
  <div class="choice-grid" id="dreamGrid"></div>
  <div class="btn-row"><button class="btn" id="dreamNext" disabled onclick="showResults()">–£–∑–Ω–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚Üí</button></div>
</div>

<!-- SCREEN: RESULTS -->
<div class="screen" id="screen-results">
  <div class="hero">
    <div class="results-container">
      <div class="hero-inner reveal">
        <div class="hero-left">
          <div class="hero-class" id="heroClass"></div>
          <p class="hero-desc" id="heroDesc"></p>
        </div>
        <div class="hero-right"><div class="hero-icon" id="heroIcon"></div></div>
      </div>
    </div>
  </div>
  <div class="results-container">
    <hr class="divider">
    <div class="level-section reveal">
      <div class="level-grid">
        <div class="lvl-badge" id="lvlBadge"></div>
        <div class="lvl-info"><div class="lvl-name" id="lvlName"></div><div class="lvl-sub" id="lvlSub"></div></div>
        <div class="xp-area"><div class="xp-meta"><span>–û–ø—ã—Ç</span><span id="xpText"></span></div><div class="xp-bar"><div class="xp-fill" id="xpFill"></div></div></div>
      </div>
      <div class="lvl-scale"><div class="lvl-pips" id="lvlPips"></div><div class="lvl-labels"><span>1 ‚Äî –ù–æ–≤–∏—á–æ–∫</span><span>4 ‚Äî –ü—Ä–∞–∫—Ç–∏–∫</span><span>7 ‚Äî –≠–∫—Å–ø–µ—Ä—Ç</span><span>10 ‚Äî –õ–µ–≥–µ–Ω–¥–∞</span></div></div>
      <div class="ach-row" id="achRow"></div>
    </div>
    <hr class="divider">
    <div class="section reveal">
      <div class="section-label">–ü—Ä–æ—Ñ–∏–ª—å</div>
      <div class="section-title">–¢–≤–æ–∏ —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã</div>
      <div class="radar-grid">
        <div class="radar-card"><h3>–°–∫–ª–æ–Ω–Ω–æ—Å—Ç—å –∫ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º</h3><canvas id="radarDir"></canvas></div>
        <div class="radar-card"><h3>–°–∫–∏–ª–ª—ã</h3><canvas id="radarSkills"></canvas></div>
      </div>
    </div>
    <hr class="divider">
    <div class="section reveal">
      <div class="section-label">–ü—Ä–æ—Ñ–Ω–∞–≤–∏–≥–∞—Ü–∏—è</div>
      <div class="section-title">–û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—è</div>
      <div class="flow-card"><div class="flow-canvas-wrap"><canvas id="flowCanvas"></canvas></div></div>
    </div>
    <hr class="divider">
    <div class="section reveal">
      <div class="section-label">–†—ã–Ω–æ–∫ —Ç—Ä—É–¥–∞</div>
      <div class="section-title">–í–æ—Å—Ç—Ä–µ–±–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–π</div>
      <div class="demand-grid" id="demandGrid"></div>
    </div>
    <hr class="divider">
    <div class="share-section reveal">
      <div class="share-title" id="shareTitle"></div>
      <button class="btn-pill" onclick="shareResult()">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º</button>
    </div>
  </div>
</div>

<script>
// ===== TELEGRAM WEB APP =====
const tg = window.Telegram && Telegram.WebApp;
if (tg) { tg.ready(); tg.expand(); }

// ===== STATE =====
const S = { edu:null, scores:{scale:50,material:50,thinking:50,comm:50,role:50}, achievements:[] };
const screens = ['screen-welcome','screen-edu','screen-kerning','screen-choice','screen-case','screen-draw','screen-assembly','screen-color','screen-font','screen-spot','screen-proportion','screen-dream','screen-results'];
let currentScreen = 'screen-welcome';
const screenHistory = [];

// ===== XP SYSTEM =====
const XP = { total:0, level:1, prevAchCount:0 };
const levelNames = ['','–ù–æ–≤–∏—á–æ–∫','–£—á–µ–Ω–∏–∫','–ü–æ–¥–º–∞—Å—Ç–µ—Ä—å–µ','–ü—Ä–∞–∫—Ç–∏–∫','–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç','–ú–∞—Å—Ç–µ—Ä','–≠–∫—Å–ø–µ—Ä—Ç','–ü—Ä–æ—Ñ–∏','–í–∏—Ä—Ç—É–æ–∑','–õ–µ–≥–µ–Ω–¥–∞'];
const xpPerLevel = [0,0,50,120,200,300,420,560,720,900,1000];
const levelSubs = ['','–¢–æ–ª—å–∫–æ –Ω–∞—á–∏–Ω–∞–µ—à—å –ø—É—Ç—å','–ü–µ—Ä–≤—ã–µ —à–∞–≥–∏ –≤ –¥–∏–∑–∞–π–Ω–µ','–§–æ—Ä–º–∏—Ä—É–µ—à—å —Å–≤–æ–π –≤–∑–≥–ª—è–¥','–†–∞—Å—Ç—ë—à—å –∫–∞–∫ –¥–∏–∑–∞–π–Ω–µ—Ä','–°–∏–ª—å–Ω—ã–µ –∑–∞–¥–∞—Ç–∫–∏ –∏ –≤–∫—É—Å','–£–≤–µ—Ä–µ–Ω–Ω–æ–µ —á—É–≤—Å—Ç–≤–æ —Ñ–æ—Ä–º—ã','–í—ã–¥–∞—é—â–∏–µ—Å—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏','–ú–∞—Å—Ç–µ—Ä—Å–∫–æ–µ –≤–ª–∞–¥–µ–Ω–∏–µ','–í–∏—Ä—Ç—É–æ–∑–Ω—ã–π –ø–æ–¥—Ö–æ–¥','–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å'];

function calcLevel(xp){for(let i=xpPerLevel.length-1;i>=1;i--){if(xp>=xpPerLevel[i])return i}return 1}
function xpProgress(xp,lvl){if(lvl>=10)return 100;const cur=xpPerLevel[lvl],next=xpPerLevel[lvl+1];return((xp-cur)/(next-cur))*100}

function showHud(){document.getElementById('xpHud').classList.add('visible')}
function updateHud(){
  const lvl=calcLevel(XP.total);const oldLvl=XP.level;const leveled=lvl>oldLvl;const fill=document.getElementById('hudFill');
  if(leveled){fill.style.width='100%';setTimeout(()=>{fill.style.transition='none';fill.style.width='0%';XP.level=lvl;document.getElementById('hudLvl').textContent=lvl;document.getElementById('hudName').textContent=levelNames[lvl];document.getElementById('hudXp').textContent=XP.total+' XP';requestAnimationFrame(()=>{fill.style.transition='width .8s cubic-bezier(.4,0,.2,1)';fill.style.width=xpProgress(XP.total,lvl)+'%'})},600)}
  else{XP.level=lvl;document.getElementById('hudLvl').textContent=lvl;document.getElementById('hudName').textContent=levelNames[lvl];document.getElementById('hudXp').textContent=XP.total+' XP';fill.style.width=xpProgress(XP.total,lvl)+'%'}
  return leveled;
}

function awardXP(amount,moduleName,accuracy,nextScreen){
  XP.total+=amount;const leveled=updateHud();
  const newAch=S.achievements.slice(XP.prevAchCount);XP.prevAchCount=S.achievements.length;
  const popup=document.getElementById('xpPopup');
  document.getElementById('popupXp').textContent='+'+amount+' XP';
  document.getElementById('popupAcc').textContent=accuracy!=null?Math.round(accuracy)+'% —Ç–æ—á–Ω–æ—Å—Ç—å':'';
  document.getElementById('popupAcc').style.display=accuracy!=null?'block':'none';
  document.getElementById('popupAch').textContent=newAch.length?'üèÖ '+newAch.join(', '):'';
  document.getElementById('popupAch').style.display=newAch.length?'block':'none';
  document.getElementById('popupLvl').style.display=leveled?'block':'none';
  const accBar=document.getElementById('popupAccBar');
  if(accuracy!=null){accBar.style.display='block';const fill=document.getElementById('popupAccFill');fill.style.width='0%';const hue=accuracy<40?0:accuracy<70?40:150;fill.style.background='hsl('+hue+',80%,55%)';setTimeout(()=>{fill.style.width=Math.round(accuracy)+'%'},100)}else{accBar.style.display='none'}
  popup.classList.add('show');
  const delay=leveled?3200:2500;
  setTimeout(()=>{popup.classList.remove('show');if(nextScreen)setTimeout(()=>go(nextScreen),300)},delay);
}

// ===== NAVIGATION =====
function go(id){
  if(currentScreen!=='screen-welcome')screenHistory.push(currentScreen);
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0,0);currentScreen=id;
  const idx=screens.indexOf(id);
  document.getElementById('progressBar').style.width=((idx/(screens.length-1))*100)+'%';
  // TG BackButton
  if(tg){
    if(id==='screen-welcome'){tg.BackButton.hide()}else{tg.BackButton.show()}
    if(id==='screen-results'){tg.MainButton.setText('–ó–∞–∫—Ä—ã—Ç—å');tg.MainButton.show()}else{tg.MainButton.hide()}
  }
  // Init screens
  if(id==='screen-kerning')initKerning();
  if(id==='screen-choice')initChoice();
  if(id==='screen-case')initCase();
  if(id==='screen-draw')initDraw();
  if(id==='screen-assembly')initAssembly();
  if(id==='screen-color')initColor();
  if(id==='screen-font')initFont();
  if(id==='screen-spot')initSpot();
  if(id==='screen-proportion')initProportion();
  if(id==='screen-dream')initDream();
  if(id==='screen-results')initResults();
}

if(tg){
  tg.BackButton.onClick(()=>{if(screenHistory.length){const prev=screenHistory.pop();document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(prev).classList.add('active');window.scrollTo(0,0);currentScreen=prev;if(prev==='screen-welcome')tg.BackButton.hide()}});
  tg.MainButton.onClick(()=>tg.close());
}

function selectCard(el,group){
  el.closest('.card-grid').querySelectorAll('.card').forEach(c=>c.classList.remove('selected'));
  el.classList.add('selected');
  if(group==='edu'){S.edu=el.dataset.v;document.getElementById('eduNext').disabled=false;showHud();awardXP(10,'–°—Ç–∞—Ä—Ç',null,null)}
}

// ===== 1. KERNING =====
function initKerning(){
  const word='DESIGN',offsets=[0,12,-9,7,-5,0],movable=[1,2,3,4];
  const container=document.getElementById('kerningWord');container.innerHTML='';
  word.split('').forEach((ch,i)=>{
    const span=document.createElement('span');span.className='kerning-letter'+(movable.includes(i)?'':' fixed');span.textContent=ch;span.style.marginLeft=offsets[i]+'px';span.dataset.offset=offsets[i];
    if(movable.includes(i)){let sx,sm;span.addEventListener('pointerdown',e=>{e.preventDefault();span.setPointerCapture(e.pointerId);sx=e.clientX;sm=parseInt(span.style.marginLeft)||0;span.classList.add('dragging');const move=e2=>{const dx=e2.clientX-sx;const v=Math.max(-20,Math.min(20,sm+dx));span.style.marginLeft=v+'px';span.dataset.offset=v};const up=()=>{span.classList.remove('dragging');span.removeEventListener('pointermove',move);span.removeEventListener('pointerup',up)};span.addEventListener('pointermove',move);span.addEventListener('pointerup',up)})}
    container.appendChild(span);
  });
}
function finishKerning(){
  const letters=document.querySelectorAll('#kerningWord .kerning-letter:not(.fixed)');let totalErr=0;
  letters.forEach(l=>{totalErr+=Math.abs(parseInt(l.dataset.offset)||0)});
  const acc=Math.max(0,100-(totalErr/letters.length)*5);
  S.scores.comm-=(acc-50)*0.3;S.scores.thinking-=(acc-50)*0.2;
  if(acc>80)S.achievements.push('–ú–∞—Å—Ç–µ—Ä –∫–µ—Ä–Ω–∏–Ω–≥–∞');
  awardXP(acc>80?80:50,'–ö–µ—Ä–Ω–∏–Ω–≥',acc,'screen-choice');
}

// ===== 2. CHOICE =====
let choiceSel=-1,argSel=-1;
const choiceData={options:[{emoji:'‚òï',label:'–ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π',axes:{thinking:-10,comm:-10}},{emoji:'üé®',label:'–≠–∫—Å–ø—Ä–µ—Å—Å–∏–≤–Ω—ã–π',axes:{thinking:15,comm:-5}},{emoji:'üìê',label:'–ì–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–π',axes:{thinking:-5,scale:5}}],arguments:[{text:'–ß–∏—Å—Ç—ã–π –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π ‚Äî –ª–µ–≥–∫–æ –∑–∞–ø–æ–º–Ω–∏—Ç—å',axes:{comm:-8,thinking:-8}},{text:'–ü–µ—Ä–µ–¥–∞—ë—Ç —ç–º–æ—Ü–∏—é –∏ –∞—Ç–º–æ—Å—Ñ–µ—Ä—É',axes:{thinking:12,comm:5}},{text:'–•–æ—Ä–æ—à–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ª—é–±–æ–º –Ω–æ—Å–∏—Ç–µ–ª–µ',axes:{thinking:-5,role:8}},{text:'–í—ã–¥–µ–ª—è–µ—Ç—Å—è —Å—Ä–µ–¥–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤',axes:{role:5,comm:-5}}]};
function initChoice(){choiceSel=-1;argSel=-1;document.getElementById('choiceGrid').innerHTML=choiceData.options.map((o,i)=>'<div class="choice-card" data-i="'+i+'" onclick="pickChoice(this)"><div class="choice-img">'+o.emoji+'</div><div class="choice-label">'+o.label+'</div></div>').join('');document.getElementById('argSection').style.display='none';document.getElementById('choiceNext').disabled=true}
function pickChoice(el){document.querySelectorAll('#choiceGrid .choice-card').forEach(c=>c.classList.remove('selected'));el.classList.add('selected');choiceSel=+el.dataset.i;document.getElementById('argGrid').innerHTML=choiceData.arguments.map((a,i)=>'<div class="arg-chip" data-i="'+i+'" onclick="pickArg(this)">'+a.text+'</div>').join('');document.getElementById('argSection').style.display='block'}
function pickArg(el){document.querySelectorAll('#argGrid .arg-chip').forEach(c=>c.classList.remove('selected'));el.classList.add('selected');argSel=+el.dataset.i;document.getElementById('choiceNext').disabled=false}
function finishChoice(){const cAxes=choiceData.options[choiceSel].axes,aAxes=choiceData.arguments[argSel].axes;Object.keys(cAxes).forEach(k=>{S.scores[k]+=cAxes[k]});Object.keys(aAxes).forEach(k=>{S.scores[k]+=aAxes[k]});S.achievements.push('–ù–∞—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–π');awardXP(60,'–ù–∞—Å–º–æ—Ç—Ä–µ–Ω–Ω–æ—Å—Ç—å',null,'screen-case')}

// ===== 3. CASE =====
const caseOpts=[{icon:'üèó',text:'–ü–µ—Ä–µ–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ ‚Äî –∑–æ–Ω—ã –¥–ª—è —Ç—É—Å–æ–≤–æ–∫, –≥–∞–º–∞–∫–∏, –ø–æ–¥–∏—É–º—ã',axes:{scale:15,material:10}},{icon:'üé®',text:'–Ø—Ä–∫–∞—è –∞–π–¥–µ–Ω—Ç–∏–∫–∞ ‚Äî –º–µ–º—ã, —Å—Ç–∏–∫–µ—Ä—ã, –Ω–∞–≤–∏–≥–∞—Ü–∏—è',axes:{comm:-15,thinking:5,material:-10}},{icon:'üì±',text:'–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Äî –∫–≤–µ—Å—Ç—ã, AR —Å –∫–Ω–∏–∂–Ω—ã–º–∏ –≥–µ—Ä–æ—è–º–∏',axes:{material:-20,comm:-10}},{icon:'üëï',text:'–ú–µ—Ä—á ‚Äî —Ö—É–¥–∏, —à–æ–ø–µ—Ä—ã, –∑–Ω–∞—á–∫–∏ –¥–ª—è —á–∏—Ç–∞—Ç–µ–ª–µ–π',axes:{material:15,thinking:15}},{icon:'ü™ë',text:'–ú–æ–¥—É–ª—å–Ω–∞—è –º–µ–±–µ–ª—å ‚Äî —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤',axes:{scale:5,material:10,thinking:-10}},{icon:'üìä',text:'–°—Ç—Ä–∞—Ç–µ–≥–∏—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è ‚Äî SMM, –∫–æ–ª–ª–∞–±—ã, –∏–≤–µ–Ω—Ç—ã',axes:{role:25,thinking:-10}}];
function initCase(){document.getElementById('caseOpts').innerHTML=caseOpts.map((o,i)=>'<div class="case-opt" data-i="'+i+'" onclick="pickCase(this)"><div class="opt-icon">'+o.icon+'</div><div class="opt-text">'+o.text+'</div></div>').join('');document.getElementById('caseNext').disabled=true}
function pickCase(el){document.querySelectorAll('#caseOpts .case-opt').forEach(c=>c.classList.remove('selected'));el.classList.add('selected');S._caseSel=+el.dataset.i;document.getElementById('caseNext').disabled=false}
function finishCase(){awardXP(70,'–ö–µ–π—Å',null,'screen-draw')}

// ===== 4. DRAWING =====
let drawCtx,drawColor='#ffffff',drawSize=3,isDrawing=false,drawW=600,drawH=400;
function initDraw(){
  const c=document.getElementById('drawCanvas');const wrap=c.parentElement;
  drawW=Math.min(600,wrap.clientWidth-40);drawH=Math.round(drawW*0.667);
  const dpr=window.devicePixelRatio||1;c.width=drawW*dpr;c.height=drawH*dpr;c.style.width=drawW+'px';c.style.height=drawH+'px';
  drawCtx=c.getContext('2d');drawCtx.scale(dpr,dpr);drawCtx.fillStyle='#1a1a1a';drawCtx.fillRect(0,0,drawW,drawH);drawCtx.lineCap='round';drawCtx.lineJoin='round';
  c.addEventListener('pointerdown',e=>{isDrawing=true;drawCtx.beginPath();const r=c.getBoundingClientRect();const sx=(e.clientX-r.left)*(drawW/r.width);const sy=(e.clientY-r.top)*(drawH/r.height);drawCtx.moveTo(sx,sy)});
  c.addEventListener('pointermove',e=>{if(!isDrawing)return;const r=c.getBoundingClientRect();drawCtx.strokeStyle=drawColor;drawCtx.lineWidth=drawSize;const sx=(e.clientX-r.left)*(drawW/r.width);const sy=(e.clientY-r.top)*(drawH/r.height);drawCtx.lineTo(sx,sy);drawCtx.stroke()});
  c.addEventListener('pointerup',()=>{isDrawing=false});c.addEventListener('pointerleave',()=>{isDrawing=false});
}
function setDrawColor(c,btn){drawColor=c;document.querySelectorAll('#drawToolbar button:not([data-group])').forEach(b=>b.classList.remove('active'));btn.classList.add('active')}
function setDrawSize(s,btn){drawSize=s;document.querySelectorAll('#drawToolbar button[data-group="size"]').forEach(b=>b.classList.remove('active'));btn.classList.add('active')}
function clearDrawCanvas(){drawCtx.fillStyle='#1a1a1a';drawCtx.fillRect(0,0,drawW,drawH)}
function finishDraw(){
  const c=document.getElementById('drawCanvas');const data=drawCtx.getImageData(0,0,c.width,c.height).data;let drawn=0;
  for(let i=0;i<data.length;i+=16){if(data[i]>30||data[i+1]>30||data[i+2]>30)drawn++}
  if(drawn>200){S.scores.thinking+=10;S.scores.comm-=5;S.achievements.push('–•—É–¥–æ–∂–Ω–∏–∫')}
  awardXP(drawn>200?80:40,'–†–∏—Å–æ–≤–∞–Ω–∏–µ',null,'screen-assembly');
}

// ===== 5. ASSEMBLY (tap-based for mobile) =====
const asmBlockData=[{id:'hero',icon:'üñº',label:'–ì–µ—Ä–æ–π-–±–∞–Ω–Ω–µ—Ä'},{id:'nav',icon:'‚ò∞',label:'–ù–∞–≤–∏–≥–∞—Ü–∏—è'},{id:'features',icon:'‚≠ê',label:'–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞'},{id:'gallery',icon:'üé®',label:'–ì–∞–ª–µ—Ä–µ—è —Ä–∞–±–æ—Ç'},{id:'testimonials',icon:'üí¨',label:'–û—Ç–∑—ã–≤—ã –∫–ª–∏–µ–Ω—Ç–æ–≤'},{id:'cta',icon:'üéØ',label:'CTA-–∫–Ω–æ–ø–∫–∞'},{id:'footer',icon:'üìã',label:'–ü–æ–¥–≤–∞–ª'},{id:'video',icon:'‚ñ∂Ô∏è',label:'–í–∏–¥–µ–æ'}];
let asmOrder=[];
function initAssembly(){
  asmOrder=[];const blocks=document.getElementById('asmBlocks');
  blocks.innerHTML=asmBlockData.map(b=>'<div class="assembly-block" data-id="'+b.id+'" onclick="addBlock(\''+b.id+'\')">'+b.icon+' '+b.label+'</div>').join('');
  document.getElementById('asmCanvas').innerHTML='<div class="assembly-canvas-title">–ù–∞–∂–∏–º–∞–π –±–ª–æ–∫–∏ —Å–ª–µ–≤–∞ ‚Üí</div>';
}
function addBlock(id){
  if(asmOrder.includes(id))return;asmOrder.push(id);const b=asmBlockData.find(x=>x.id===id);
  const el=document.querySelector('.assembly-block[data-id="'+id+'"]');if(el)el.style.display='none';
  const slot=document.createElement('div');slot.className='assembly-slot';slot.innerHTML=b.icon+' '+b.label+' <span class="remove" onclick="removeBlock(\''+id+'\',this)">‚úï</span>';
  document.getElementById('asmCanvas').appendChild(slot);
}
function removeBlock(id,el){asmOrder=asmOrder.filter(x=>x!==id);el.parentElement.remove();const pb=document.querySelector('.assembly-block[data-id="'+id+'"]');if(pb)pb.style.display=''}
function finishAssembly(){
  let score=0;if(asmOrder[0]==='nav')score+=20;if(asmOrder.indexOf('hero')<=1)score+=15;if(asmOrder.indexOf('cta')>=asmOrder.length-3)score+=15;if(asmOrder[asmOrder.length-1]==='footer')score+=20;if(asmOrder.length>=5)score+=10;
  S.scores.comm-=score*0.2;S.scores.role+=score*0.15;if(score>=60)S.achievements.push('–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –º–∞–∫–µ—Ç–æ–≤');
  const asmAcc=Math.min(100,score*1.25);awardXP(score>=60?90:55,'–ö–æ–º–ø–æ–∑–∏—Ü–∏—è',asmAcc,'screen-color');
}

// ===== 6. COLOR =====
const colorPalettes=[{colors:['#1a1a2e','#16213e','#533483','#e94560'],label:'–¢—ë–º–Ω—ã–π –∫–æ–Ω—Ç—Ä–∞—Å—Ç',axes:{thinking:10,comm:-5}},{colors:['#a8e6cf','#dcedc1','#ffd3b6','#ffaaa5'],label:'–ú—è–≥–∫–∞—è –ø–∞—Å—Ç–µ–ª—å',axes:{thinking:-5,material:10}},{colors:['#2d3436','#636e72','#b2bec3','#dfe6e9'],label:'–ú–æ–Ω–æ—Ö—Ä–æ–º —Å–µ—Ä—ã–π',axes:{thinking:-15,role:10}},{colors:['#6c5ce7','#a29bfe','#fd79a8','#fdcb6e'],label:'–Ø—Ä–∫–∏–π –º–∏–∫—Å',axes:{thinking:15,comm:-10}}];
let colorSel=-1;
function initColor(){colorSel=-1;document.getElementById('colorOpts').innerHTML=colorPalettes.map((p,i)=>'<div class="color-opt" data-i="'+i+'" onclick="pickColor(this)"><div class="color-swatches">'+p.colors.map(c=>'<div style="background:'+c+'"></div>').join('')+'</div><div class="color-opt-label">'+p.label+'</div></div>').join('');document.getElementById('colorNext').disabled=true}
function pickColor(el){document.querySelectorAll('.color-opt').forEach(c=>c.classList.remove('selected'));el.classList.add('selected');colorSel=+el.dataset.i;document.getElementById('colorNext').disabled=false}
function finishColor(){const axes=colorPalettes[colorSel].axes;Object.keys(axes).forEach(k=>{S.scores[k]+=axes[k]});const colorAcc=colorSel===1?95:colorSel===2?60:colorSel===0?45:55;awardXP(60,'–¶–≤–µ—Ç',colorAcc,'screen-font')}

// ===== 7. FONT =====
const fontData=[{head:'Times New Roman',body:'Georgia',style:'font-family:Times New Roman,serif',label:'–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –∞–Ω—Ç–∏–∫–≤–∞',axes:{thinking:-10,role:10}},{head:'Helvetica',body:'Arial',style:'font-family:Helvetica,Arial,sans-serif',label:'–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π –≥—Ä–æ—Ç–µ—Å–∫',axes:{thinking:-5,comm:-5}},{head:'Playfair Display',body:'Source Sans Pro',style:'font-family:Georgia,serif;letter-spacing:1px',label:'–ö–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–∞—è –ø–∞—Ä–∞',axes:{thinking:5,material:5}},{head:'Courier New',body:'Courier',style:'font-family:Courier New,monospace',label:'–ú–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–π',axes:{thinking:15,material:-10}}];
let fontSel=-1;
function initFont(){fontSel=-1;document.getElementById('fontPairs').innerHTML=fontData.map((f,i)=>'<div class="font-pair" data-i="'+i+'" onclick="pickFont(this)"><div class="font-left"><div class="font-sample" style="'+f.style+';font-size:28px;font-weight:bold">–ê–∞</div></div><div class="font-right"><div class="font-sample" style="'+f.style+';font-size:18px;font-weight:bold">–ó–∞–≥–æ–ª–æ–≤–æ–∫</div><div class="font-sample" style="'+f.style+';font-size:14px;color:var(--muted)">–û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç</div><div class="font-name">'+f.label+'</div></div></div>').join('');document.getElementById('fontNext').disabled=true}
function pickFont(el){document.querySelectorAll('.font-pair').forEach(c=>c.classList.remove('selected'));el.classList.add('selected');fontSel=+el.dataset.i;document.getElementById('fontNext').disabled=false}
function finishFont(){const axes=fontData[fontSel].axes;Object.keys(axes).forEach(k=>{S.scores[k]+=axes[k]});const fontAcc=fontSel===0?92:fontSel===2?78:fontSel===1?55:30;awardXP(60,'–®—Ä–∏—Ñ—Ç—ã',fontAcc,'screen-spot')}

// ===== 8. SPOT ERROR =====
const spotData={items:[{text:'16px ¬∑ Gilroy',ok:true},{text:'#222222 —Ñ–æ–Ω',ok:true},{text:'line-height: 1.6',ok:true},{text:'Comic Sans MS',ok:false},{text:'8px –æ—Ç—Å—Ç—É–ø —Å–µ—Ç–∫–∏',ok:true},{text:'border-radius: 12px',ok:true}]};
let spotSel=null;
function initSpot(){spotSel=null;document.getElementById('spotItems').innerHTML=spotData.items.map((item,i)=>'<div class="spot-item" data-i="'+i+'" onclick="pickSpot(this)">'+item.text+'</div>').join('');document.getElementById('spotNext').disabled=true}
function pickSpot(el){document.querySelectorAll('.spot-item').forEach(c=>c.classList.remove('selected'));el.classList.add('selected');spotSel=+el.dataset.i;document.getElementById('spotNext').disabled=false}
function finishSpot(){const item=spotData.items[spotSel];if(!item.ok){S.scores.thinking-=10;S.scores.comm-=5;S.achievements.push('–ó–æ—Ä–∫–∏–π –≥–ª–∞–∑')}const spotAcc=!item.ok?100:20;awardXP(!item.ok?80:40,'–î–µ—Ç–∞–ª–∏',spotAcc,'screen-proportion')}

// ===== 9. PROPORTION =====
let propRatio=50,propW=560,propH=200;
function initProportion(){
  propRatio=50;const c=document.getElementById('propCanvas');
  propW=Math.min(560,c.parentElement.clientWidth-40);propH=Math.round(propW*0.357);
  drawProportion();
  const move=e=>{const r=c.getBoundingClientRect();propRatio=Math.max(20,Math.min(80,((e.clientX-r.left)/r.width)*100));drawProportion()};
  c.addEventListener('pointerdown',e=>{move(e);c.setPointerCapture(e.pointerId);c.addEventListener('pointermove',move);c.addEventListener('pointerup',()=>c.removeEventListener('pointermove',move),{once:true})});
}
function drawProportion(){
  const c=document.getElementById('propCanvas');const ctx=c.getContext('2d');const dpr=window.devicePixelRatio||1;
  c.width=propW*dpr;c.height=propH*dpr;c.style.width=propW+'px';c.style.height=propH+'px';ctx.scale(dpr,dpr);
  const W=propW,H=propH,pad=16;const split=pad+(W-2*pad)*(propRatio/100);
  ctx.fillStyle='#1a1a1a';ctx.fillRect(0,0,W,H);
  ctx.fillStyle='rgba(0,229,255,0.15)';ctx.fillRect(pad,pad,split-pad,H-2*pad);ctx.strokeStyle='rgba(0,229,255,0.5)';ctx.lineWidth=1.5;ctx.strokeRect(pad,pad,split-pad,H-2*pad);
  ctx.fillStyle='rgba(179,136,255,0.15)';ctx.fillRect(split,pad,W-pad-split,H-2*pad);ctx.strokeStyle='rgba(179,136,255,0.5)';ctx.strokeRect(split,pad,W-pad-split,H-2*pad);
  ctx.beginPath();ctx.moveTo(split,pad-5);ctx.lineTo(split,H-pad+5);ctx.strokeStyle='#fff';ctx.lineWidth=2;ctx.stroke();
  ctx.beginPath();ctx.arc(split,H/2,8,0,Math.PI*2);ctx.fillStyle='#fff';ctx.fill();
  document.getElementById('propValue').textContent=Math.round(propRatio)+' : '+(100-Math.round(propRatio));
}
function finishProportion(){const golden=61.8;const err=Math.abs(propRatio-golden);const acc=Math.max(0,100-err*3);S.scores.scale+=acc*0.15;S.scores.thinking-=acc*0.1;if(err<5)S.achievements.push('–ó–æ–ª–æ—Ç–æ–µ —Å–µ—á–µ–Ω–∏–µ');const propAcc=Math.max(5,Math.round(100-err*2.5));awardXP(err<5?90:err<15?65:40,'–ü—Ä–æ–ø–æ—Ä—Ü–∏–∏',propAcc,'screen-dream')}

// ===== 10. DREAM =====
const dreamProjects=[{emoji:'üè†',label:'–°–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–æ–º —É –º–æ—Ä—è',axes:{scale:20,material:15}},{emoji:'üëó',label:'–°–æ–∑–¥–∞—Ç—å –±—Ä–µ–Ω–¥ –æ–¥–µ–∂–¥—ã',axes:{material:20,thinking:15}},{emoji:'üì±',label:'–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –º—É–∑–µ—è',axes:{material:-20,comm:-15}},{emoji:'ü™ë',label:'–õ–∏–Ω–µ–π–∫–∞ –º–µ–±–µ–ª–∏',axes:{material:10,scale:5}},{emoji:'üé™',label:'–û—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –≤—ã—Å—Ç–∞–≤–∫—É',axes:{role:25,thinking:-5}},{emoji:'üíé',label:'–Æ–≤–µ–ª–∏—Ä–Ω–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è',axes:{material:20,thinking:20}},{emoji:'ü™¥',label:'–ò–Ω—Ç–µ—Ä—å–µ—Ä —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞',axes:{scale:15,material:10}},{emoji:'üñº',label:'AR-–∏–Ω—Å—Ç–∞–ª–ª—è—Ü–∏—è',axes:{material:-15,thinking:10}}];
function initDream(){S._dreamSel=[];document.getElementById('dreamGrid').innerHTML=dreamProjects.map((p,i)=>'<div class="choice-card" data-i="'+i+'" onclick="pickDream(this)"><div class="choice-img">'+p.emoji+'</div><div class="choice-label">'+p.label+'</div></div>').join('');document.getElementById('dreamNext').disabled=true}
function pickDream(el){const idx=+el.dataset.i;const pos=S._dreamSel.indexOf(idx);if(pos>-1){S._dreamSel.splice(pos,1);el.classList.remove('selected')}else if(S._dreamSel.length<2){S._dreamSel.push(idx);el.classList.add('selected')}document.getElementById('dreamNext').disabled=S._dreamSel.length!==2}

// ===== SHOW RESULTS =====
function showResults(){
  if(S._caseSel!==undefined){const axes=caseOpts[S._caseSel].axes;Object.keys(axes).forEach(k=>{S.scores[k]+=axes[k]})}
  (S._dreamSel||[]).forEach(idx=>{const axes=dreamProjects[idx].axes;Object.keys(axes).forEach(k=>{S.scores[k]+=axes[k]})});
  Object.keys(S.scores).forEach(k=>{S.scores[k]=Math.max(5,Math.min(95,S.scores[k]))});
  S.achievements.push('–ú–µ—á—Ç–∞—Ç–µ–ª—å');XP.total+=70;updateHud();
  go('screen-results');
}

// ===== RESULTS LOGIC =====
const clusters={
  arch:{name:'–ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π\n–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä',icon:'üèõ',profile:[85,75,45,80,20],desc:'–¢—ã –º—ã—Å–ª–∏—à—å –æ–±—ä—ë–º–∞–º–∏ –∏ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞–º–∏. –¢–µ–±–µ –≤–∞–∂–Ω–æ, –∫–∞–∫ –∑–¥–∞–Ω–∏–µ –≤—Å—Ç–∞—ë—Ç –≤ –≥–æ—Ä–æ–¥—Å–∫—É—é —Ç–∫–∞–Ω—å, –∫–∞–∫ —Å–≤–µ—Ç –ø–∞–¥–∞–µ—Ç –≤ –∫–æ–º–Ω–∞—Ç—É.'},
  env:{name:'–°–æ–∑–¥–∞—Ç–µ–ª—å\n–ê—Ç–º–æ—Å—Ñ–µ—Ä',icon:'ü™¥',profile:[70,65,60,55,20],desc:'–¢—ã —Å–æ–∑–¥–∞—ë—à—å –Ω–µ –ø—Ä–æ—Å—Ç–æ –∏–Ω—Ç–µ—Ä—å–µ—Ä—ã ‚Äî —Ç—ã —Å–æ–∑–¥–∞—ë—à—å —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∂–∏–∑–Ω–∏. –ö–∞–∂–¥–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ ‚Äî –∏—Å—Ç–æ—Ä–∏—è.'},
  graphic:{name:'–¶–∏—Ñ—Ä–æ–≤–æ–π\n–í–∏–∑–∏–æ–Ω–µ—Ä',icon:'üñ•',profile:[35,15,40,20,25],desc:'–¢—ã –¥—É–º–∞–µ—à—å —ç–∫—Ä–∞–Ω–∞–º–∏ –∏ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è–º–∏. –ü–∏–∫—Å–µ–ª—å, —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞, –∞–Ω–∏–º–∞—Ü–∏—è ‚Äî —Ç–≤–æ–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã.'},
  fashion:{name:'–ú–∞—Å—Ç–µ—Ä\n–ú–∞—Ç–µ—Ä–∏–π',icon:'‚úÇÔ∏è',profile:[15,85,80,75,10],desc:'–¢—ã —á—É–≤—Å—Ç–≤—É–µ—à—å –º–∞—Ç–µ—Ä–∏–∞–ª –∏ —Ç–µ–ª–æ. –¢–∫–∞–Ω—å, –º–µ—Ç–∞–ª–ª, —Ñ–æ—Ä–º–∞ –∫–æ—Å—Ç—é–º–∞ ‚Äî –¥–∏–∑–∞–π–Ω –Ω–µ–æ—Ç–¥–µ–ª–∏–º –æ—Ç —Ç–∞–∫—Ç–∏–ª—å–Ω–æ—Å—Ç–∏.'},
  product:{name:'–ò–Ω–∂–µ–Ω–µ—Ä\n–§–æ—Ä–º—ã',icon:'ü™ë',profile:[20,55,30,65,20],desc:'–¢—ã —Å–æ–µ–¥–∏–Ω—è–µ—à—å —Ñ—É–Ω–∫—Ü–∏—é –∏ –∫—Ä–∞—Å–æ—Ç—É. –ö–∞–∂–¥—ã–π –ø—Ä–µ–¥–º–µ—Ç ‚Äî –∑–∞–¥–∞—á–∞ –Ω–∞ —Å—Ç—ã–∫–µ –∏–Ω–∂–µ–Ω–µ—Ä–∏–∏ –∏ —ç—Å—Ç–µ—Ç–∏–∫–∏.'},
  mgmt:{name:'–°—Ç—Ä–∞—Ç–µ–≥\n–î–∏–∑–∞–π–Ω–∞',icon:'üìã',profile:[50,30,15,10,85],desc:'–¢—ã –≤–∏–¥–∏—à—å –¥–∏–∑–∞–π–Ω –∫–∞–∫ —Å–∏—Å—Ç–µ–º—É. –£–ø—Ä–∞–≤–ª—è–µ—à—å –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏ –∏ –≤—ã—Å—Ç—Ä–∞–∏–≤–∞–µ—à—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é.'}
};
const clusterLabels={graphic:'–ì—Ä–∞—Ñ–∏–∫–∞ –∏ —Ü–∏—Ñ—Ä–∞',arch:'–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ',env:'–°—Ä–µ–¥–∞ –∏ –∏–Ω—Ç–µ—Ä—å–µ—Ä',fashion:'–ú–æ–¥–∞ –∏ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã',product:'–ü—Ä–æ–¥—É–∫—Ç –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏',mgmt:'–ú–µ–Ω–µ–¥–∂–º–µ–Ω—Ç –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è'};

function findCluster(){
  const vec=[S.scores.scale,S.scores.material,S.scores.thinking,S.scores.comm,S.scores.role];
  let best=null,bestDist=Infinity,second=null,secondDist=Infinity;
  for(const[key,c]of Object.entries(clusters)){const dist=Math.sqrt(c.profile.reduce((sum,v,i)=>sum+(v-vec[i])**2,0));if(dist<bestDist){second=best;secondDist=bestDist;best=key;bestDist=dist}else if(dist<secondDist){second=key;secondDist=dist}}
  return{primary:best,secondary:second};
}
function computeDirections(){
  const vec=[S.scores.scale,S.scores.material,S.scores.thinking,S.scores.comm,S.scores.role];const result={};
  for(const[key,c]of Object.entries(clusters)){const dist=Math.sqrt(c.profile.reduce((sum,v,i)=>sum+(v-vec[i])**2,0));result[key]=Math.max(5,Math.round(100-dist*0.5))}return result;
}
function computeSkills(){return{space:Math.max(8,Math.min(95,S.scores.scale)),material:Math.max(8,Math.min(95,S.scores.material)),visual:Math.max(8,Math.min(95,Math.round(50+(50-S.scores.thinking)*0.8))),comm:Math.max(8,Math.min(95,Math.round(50+(50-S.scores.comm)*0.7))),strategy:Math.max(8,Math.min(95,S.scores.role))}}

const demandData={
  graphic:[{icon:'üé®',title:'–ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –¥–∏–∑–∞–π–Ω–µ—Ä',vacancies:11200,salary:'95‚Äì180',growth:'+18%',trend:'up',demand:82,skills:['Illustrator','–¢–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞','–ë—Ä–µ–Ω–¥–∏–Ω–≥','Figma'],color:'#00e5ff',years:['2020','2021','2022','2023','2024','2025'],chart:[5800,6400,7200,8100,9500,11200]},{icon:'ü•Ω',title:'–î–∏–∑–∞–π–Ω–µ—Ä VR/AR',vacancies:3800,salary:'150‚Äì400',growth:'+42%',trend:'up',demand:76,skills:['Unity','Unreal','3D','Blender'],color:'#b388ff',years:['2020','2021','2022','2023','2024','2025'],chart:[600,900,1400,2100,2700,3800]}],
  arch:[{icon:'üèõ',title:'–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä',vacancies:4500,salary:'100‚Äì280',growth:'+12%',trend:'up',demand:70,skills:['Revit','AutoCAD','BIM','ArchiCAD'],color:'#00e5ff',years:['2020','2021','2022','2023','2024','2025'],chart:[2800,3100,3400,3700,4100,4500]}],
  env:[{icon:'ü™¥',title:'–î–∏–∑–∞–π–Ω–µ—Ä –∏–Ω—Ç–µ—Ä—å–µ—Ä–æ–≤',vacancies:4800,salary:'80‚Äì250',growth:'+39%',trend:'up',demand:68,skills:['3ds Max','AutoCAD','SketchUp'],color:'#00e5ff',years:['2020','2021','2022','2023','2024','2025'],chart:[1800,2100,2600,3100,3500,4800]}],
  fashion:[{icon:'üëó',title:'Fashion-–¥–∏–∑–∞–π–Ω–µ—Ä',vacancies:2900,salary:'80‚Äì300',growth:'+20%',trend:'up',demand:60,skills:['–ö–æ–Ω—Å—Ç—Ä—É–∏—Ä–æ–≤–∞–Ω–∏–µ','CLO 3D','–¢–µ–∫—Å—Ç–∏–ª—å'],color:'#00e5ff',years:['2020','2021','2022','2023','2024','2025'],chart:[1400,1600,1900,2200,2500,2900]}],
  product:[{icon:'ü™ë',title:'–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω–µ—Ä',vacancies:2400,salary:'90‚Äì250',growth:'+22%',trend:'up',demand:66,skills:['SolidWorks','Rhino','KeyShot'],color:'#00e5ff',years:['2020','2021','2022','2023','2024','2025'],chart:[1100,1300,1500,1800,2000,2400]},{icon:'üì±',title:'UX/UI –¥–∏–∑–∞–π–Ω–µ—Ä',vacancies:15000,salary:'120‚Äì350',growth:'+35%',trend:'up',demand:90,skills:['Figma','–Æ–∑–∞–±–∏–ª–∏—Ç–∏','–ü—Ä–æ—Ç–æ—Ç–∏–ø—ã'],color:'#b388ff',years:['2020','2021','2022','2023','2024','2025'],chart:[5000,7000,9500,11500,13000,15000]}],
  mgmt:[{icon:'üéØ',title:'–ê—Ä—Ç-–¥–∏—Ä–µ–∫—Ç–æ—Ä',vacancies:3600,salary:'150‚Äì400',growth:'+18%',trend:'up',demand:72,skills:['–ë—Ä–µ–Ω–¥–∏–Ω–≥','–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ','–°—Ç—Ä–∞—Ç–µ–≥–∏—è'],color:'#00e5ff',years:['2020','2021','2022','2023','2024','2025'],chart:[1800,2100,2400,2800,3200,3600]}]
};

const flowCols=[{label:'–ö–û–õ–õ–ï–î–ñ',nodes:['–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä','–ì—Ä–∞—Ñ. –¥–∏–∑–∞–π–Ω–µ—Ä','–î–∏–∑–∞–π–Ω–µ—Ä','–î–∏–∑–∞–π–Ω–µ—Ä (–∫–æ—Å—Ç—é–º)']},{label:'–ï–ì–≠',nodes:['–†—É—Å—Å–∫–∏–π —è–∑—ã–∫','–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞','–ò—Å—Ç–æ—Ä–∏—è']},{label:'–ë–ê–ö–ê–õ–ê–í–†–ò–ê–¢',nodes:['–ê—Ä—Ö–∏—Ç–µ–∫—Ç. –ø—Ä–æ–µ–∫—Ç.','–ê—Ä—Ö–∏—Ç–µ–∫—Ç. –¥–∏–∑–∞–π–Ω','–ì—Ä–∞—Ñ. –¥–∏–∑–∞–π–Ω –∏ VR','–î–∏–∑–∞–π–Ω —Å—Ä–µ–¥—ã','–ü—Ä–æ–º–¥–∏–∑–∞–π–Ω','–î–∏–∑–∞–π–Ω –∫–æ—Å—Ç—é–º–∞','–¢–µ–∫—Å—Ç–∏–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω','–£–∫—Ä–∞—à–µ–Ω–∏—è','–ê—Ä—Ç-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç','–ò—Å–∫—É—Å—Å—Ç–≤–æ–≤–µ–¥.']},{label:'–ú–ê–ì–ò–°–¢–†–ê–¢–£–†–ê',nodes:['–¶–∏—Ñ—Ä–æ–≤–æ–π –¥–∏–∑–∞–π–Ω','–¶–∏—Ñ—Ä. –ø—Ä–æ–¥—É–∫—Ç','–ö—Ä–µ–∞—Ç–∏–≤. –∏–Ω–¥—É—Å—Ç—Ä–∏–∏']},{label:'–ê–°–ü–ò–†–ê–ù–¢–£–†–ê',nodes:['–î–ü–ò','–¢–µ—Ö–Ω. —ç—Å—Ç–µ—Ç–∏–∫–∞','–¢–µ–æ—Ä–∏—è –∫—É–ª—å—Ç—É—Ä—ã']}];
const flowEdges=[[0,1,1,0],[0,1,1,1],[1,0,2,2],[1,1,2,2],[2,2,3,0],[0,1,1,2],[1,0,2,3],[1,1,2,3],[1,2,2,3],[2,2,3,1],[2,3,3,1],[3,0,4,1],[0,0,1,0],[0,0,1,1],[0,0,1,2],[1,0,2,0],[1,1,2,0],[1,2,2,0],[1,0,2,1],[1,1,2,1],[0,2,1,0],[0,2,1,1],[1,0,2,4],[1,1,2,4],[0,3,1,0],[0,3,1,1],[1,0,2,5],[1,1,2,5],[2,8,3,2],[3,2,4,2],[2,0,4,0],[1,0,2,6],[1,1,2,6],[1,0,2,7],[1,1,2,7],[1,0,2,8],[1,1,2,8],[1,0,2,9],[1,1,2,9],[2,4,3,1],[3,1,4,1],[2,5,3,2],[3,2,4,1]];

const clusterFlowNodes={
  graphic:{my:{'0,1':1,'1,0':1,'1,1':1,'2,2':1,'3,0':1},alt:{'1,2':1,'2,3':1,'3,1':1,'4,1':1},badges:{'0,1':'—Ç—ã –∑–¥–µ—Å—å','2,2':'—Ä–µ–∫.'}},
  arch:{my:{'0,0':1,'1,0':1,'1,1':1,'1,2':1,'2,0':1,'2,1':1},alt:{'2,3':1,'3,0':1,'4,0':1},badges:{'0,0':'—Ç—ã –∑–¥–µ—Å—å','2,0':'—Ä–µ–∫.'}},
  env:{my:{'0,2':1,'1,0':1,'1,1':1,'2,3':1},alt:{'1,2':1,'2,2':1,'3,1':1,'4,1':1},badges:{'0,2':'—Ç—ã –∑–¥–µ—Å—å','2,3':'—Ä–µ–∫.'}},
  fashion:{my:{'0,3':1,'1,0':1,'1,1':1,'2,5':1},alt:{'2,6':1,'2,7':1,'3,2':1,'4,2':1},badges:{'0,3':'—Ç—ã –∑–¥–µ—Å—å','2,5':'—Ä–µ–∫.'}},
  product:{my:{'0,2':1,'1,0':1,'1,1':1,'2,4':1},alt:{'2,2':1,'2,3':1,'3,0':1,'3,1':1},badges:{'0,2':'—Ç—ã –∑–¥–µ—Å—å','2,4':'—Ä–µ–∫.'}},
  mgmt:{my:{'1,0':1,'1,1':1,'2,8':1,'2,9':1,'3,2':1,'4,2':1},alt:{'2,2':1,'3,0':1,'3,1':1},badges:{'2,8':'—Ç—ã –∑–¥–µ—Å—å','3,2':'—Ä–µ–∫.'}}
};

function getNodePath(ci,ni,ck){const k=ci+','+ni;const cfg=clusterFlowNodes[ck];if(cfg.my[k])return'my';if(cfg.alt[k])return'alt';return'dim'}
function getNodeBadge(ci,ni,ck){return clusterFlowNodes[ck].badges[ci+','+ni]||null}
function getEdgeType(fc,fi,tc,ti,ck){const f=getNodePath(fc,fi,ck),t=getNodePath(tc,ti,ck);if(f==='my'&&t==='my')return'my';if(f!=='dim'&&t!=='dim')return'alt';return'dim'}

function initResults(){
  const{primary,secondary}=findCluster();const dirs=computeDirections();const skills=computeSkills();const cl=clusters[primary];
  const level=XP.level;const xp=XP.total;
  // HERO
  const parts=cl.name.split('\n');
  document.getElementById('heroClass').innerHTML='<span class="highlight">'+parts[0]+'</span><br>'+parts[1];
  document.getElementById('heroDesc').textContent=cl.desc;document.getElementById('heroIcon').textContent=cl.icon;
  // LEVEL
  document.getElementById('lvlBadge').innerHTML=level+'<span>–£—Ä–æ–≤–µ–Ω—å</span>';
  document.getElementById('lvlName').textContent=levelNames[level];document.getElementById('lvlSub').textContent=levelSubs[level];
  document.getElementById('xpText').textContent=xp+' / 1 000 XP';
  setTimeout(()=>{document.getElementById('xpFill').style.width=Math.min(100,xp/10)+'%'},500);
  // PIPS
  const wrap=document.getElementById('lvlPips');let html='';for(let i=1;i<=10;i++){const cls=i<level?'filled':i===level?'current':'';html+='<div class="lvl-pip '+cls+'"></div>'}wrap.innerHTML=html;
  // ACHIEVEMENTS
  if(S.achievements.length){document.getElementById('achRow').innerHTML=S.achievements.map(a=>'<div class="ach-item">üèÖ '+a+'</div>').join('')}
  // RADARS
  const radarSize=Math.min(360,window.innerWidth-60);
  drawRadar('radarDir',['–ê—Ä—Ö–∏—Ç–µ–∫—Ç.','–°—Ä–µ–¥–∞','–ì—Ä–∞—Ñ–∏–∫–∞','–ú–æ–¥–∞','–ü—Ä–æ–º–¥–∏–∑.','–ú–µ–Ω–µ–¥–∂–º.'],[dirs.arch,dirs.env,dirs.graphic,dirs.fashion,dirs.product,dirs.mgmt],'#00e5ff','#b388ff',radarSize);
  drawRadar('radarSkills',['–ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ','–ú–∞—Ç–µ—Ä–∏–∞–ª','–í–∏–∑—É–∞–ª','–ö–æ–º–º—É–Ω–∏–∫.','–°—Ç—Ä–∞—Ç–µ–≥–∏—è'],[skills.space,skills.material,skills.visual,skills.comm,skills.strategy],'#b388ff','#ff6b9d',radarSize);
  // FLOW
  drawFlowCanvas(primary);
  // DEMAND
  renderDemand(primary,secondary);
  // SHARE
  document.getElementById('shareTitle').textContent=parts.join(' ')+' ¬∑ –£—Ä–æ–≤–µ–Ω—å '+level;
  // REVEAL
  setTimeout(()=>{const obs=new IntersectionObserver(entries=>{entries.forEach(e=>{if(e.isIntersecting)e.target.classList.add('visible')})},{threshold:0.08});document.querySelectorAll('#screen-results .reveal').forEach(el=>obs.observe(el))},200);
  // Hide XP HUD on results
  document.getElementById('xpHud').classList.remove('visible');
  document.getElementById('progressBar').style.width='100%';
}

function drawRadar(canvasId,labels,values,color1,color2,SIZE){
  SIZE=SIZE||360;const canvas=document.getElementById(canvasId);const dpr=window.devicePixelRatio||1;
  canvas.width=SIZE*dpr;canvas.height=SIZE*dpr;canvas.style.width=SIZE+'px';canvas.style.height=SIZE+'px';
  const ctx=canvas.getContext('2d');ctx.scale(dpr,dpr);
  const cx=SIZE/2,cy=SIZE/2,R=SIZE*0.3,n=labels.length;let frame=0;const total=60;
  function ang(i){return(Math.PI*2*i/n)-Math.PI/2}
  function hexToRgb(hex){return parseInt(hex.slice(1,3),16)+','+parseInt(hex.slice(3,5),16)+','+parseInt(hex.slice(5,7),16)}
  const rgb1=hexToRgb(color1),rgb2=hexToRgb(color2);
  function draw(p){
    const ease=1-Math.pow(1-p,3);ctx.clearRect(0,0,SIZE,SIZE);
    for(let ring=1;ring<=5;ring++){const r=R*ring/5;ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);ctx.strokeStyle=ring===5?'rgba('+rgb1+',0.2)':'rgba(255,255,255,0.04)';ctx.lineWidth=ring===5?1.5:1;ctx.stroke()}
    for(let i=0;i<n;i++){const a=ang(i);ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+R*Math.cos(a),cy+R*Math.sin(a));ctx.strokeStyle='rgba(255,255,255,0.05)';ctx.lineWidth=1;ctx.stroke()}
    ctx.beginPath();for(let i=0;i<=n;i++){const idx=i%n,v=(values[idx]/100)*R*ease,a=ang(idx);const x=cx+v*Math.cos(a),y=cy+v*Math.sin(a);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y)}ctx.closePath();
    const grad=ctx.createLinearGradient(cx-R,cy-R,cx+R,cy+R);grad.addColorStop(0,'rgba('+rgb1+',0.2)');grad.addColorStop(1,'rgba('+rgb2+',0.08)');ctx.fillStyle=grad;ctx.fill();
    const strokeGrad=ctx.createLinearGradient(cx-R,cy-R,cx+R,cy+R);strokeGrad.addColorStop(0,color1);strokeGrad.addColorStop(1,color2);ctx.strokeStyle=strokeGrad;ctx.lineWidth=2;ctx.stroke();
    for(let i=0;i<n;i++){const v=(values[i]/100)*R*ease,a=ang(i);const dx=cx+v*Math.cos(a),dy=cy+v*Math.sin(a);const t=i/(n-1);ctx.beginPath();ctx.arc(dx,dy,4,0,Math.PI*2);ctx.fillStyle=t<0.5?color1:color2;ctx.fill()}
    for(let i=0;i<n;i++){const a=ang(i),val=Math.round(values[i]*ease);const dist=R+30;const lx=cx+dist*Math.cos(a),ly=cy+dist*Math.sin(a);const cos=Math.cos(a);ctx.textAlign=cos>0.3?'left':cos<-0.3?'right':'center';ctx.textBaseline='bottom';ctx.font='800 14px PPNeueMachina,sans-serif';const t=i/(n-1);ctx.fillStyle=t<0.5?color1:color2;ctx.fillText(val,lx,ly);ctx.textBaseline='top';ctx.font='600 12px Gilroy,sans-serif';ctx.fillStyle='#868686';ctx.fillText(labels[i],lx,ly+2)}
  }
  function animate(){frame++;draw(Math.min(1,frame/total));if(frame<total)requestAnimationFrame(animate)}
  const obs=new IntersectionObserver(entries=>{if(entries[0].isIntersecting){animate();obs.disconnect()}},{threshold:0.3});obs.observe(canvas);
}

function drawFlowCanvas(clusterKey){
  const canvas=document.getElementById('flowCanvas');const dpr=window.devicePixelRatio||1;const W=1200,H=640;
  canvas.width=W*dpr;canvas.height=H*dpr;canvas.style.width=W+'px';canvas.style.height=H+'px';
  const ctx=canvas.getContext('2d');ctx.scale(dpr,dpr);
  const gap=12,colW=(W-40-gap*4)/5,startX=20;const colXs=[];for(let i=0;i<5;i++)colXs.push(startX+i*(colW+gap));
  const nodeH=44,gapY=6,topY=44;const rects=[];
  flowCols.forEach((col,ci)=>{rects[ci]=[];col.nodes.forEach((name,ni)=>{rects[ci][ni]={x:colXs[ci],y:topY+ni*(nodeH+gapY),w:colW,h:nodeH,name,path:getNodePath(ci,ni,clusterKey),badge:getNodeBadge(ci,ni,clusterKey)}})});
  ctx.fillStyle='#222222';ctx.fillRect(0,0,W,H);
  ctx.textAlign='center';ctx.textBaseline='middle';flowCols.forEach((col,ci)=>{ctx.font='800 12px PPNeueMachina,sans-serif';ctx.fillStyle='#868686';ctx.fillText(col.label,colXs[ci]+colW/2,20)});
  flowEdges.forEach(([fc,fi,tc,ti])=>{const from=rects[fc]?.[fi],to=rects[tc]?.[ti];if(!from||!to)return;const x1=from.x+from.w,y1=from.y+from.h/2,x2=to.x,y2=to.y+to.h/2,mx=(x1+x2)/2;const type=getEdgeType(fc,fi,tc,ti,clusterKey);ctx.beginPath();ctx.moveTo(x1,y1);ctx.bezierCurveTo(mx,y1,mx,y2,x2,y2);if(type==='my'){ctx.strokeStyle='rgba(0,229,255,0.5)';ctx.lineWidth=2.5;ctx.shadowColor='rgba(0,229,255,0.2)';ctx.shadowBlur=6}else if(type==='alt'){ctx.strokeStyle='rgba(251,191,36,0.35)';ctx.lineWidth=1.5;ctx.setLineDash([5,4]);ctx.shadowBlur=0}else{ctx.strokeStyle='rgba(255,255,255,0.04)';ctx.lineWidth=1;ctx.shadowBlur=0}ctx.stroke();ctx.setLineDash([]);ctx.shadowBlur=0});
  flowCols.forEach((col,ci)=>{col.nodes.forEach((name,ni)=>{const r=rects[ci][ni];ctx.beginPath();ctx.rect(r.x,r.y,r.w,r.h);if(r.path==='my'){ctx.fillStyle='rgba(0,229,255,0.06)';ctx.strokeStyle='rgba(0,229,255,0.6)';ctx.lineWidth=1.5}else if(r.path==='alt'){ctx.fillStyle='rgba(251,191,36,0.04)';ctx.strokeStyle='rgba(251,191,36,0.3)';ctx.lineWidth=1}else{ctx.fillStyle='rgba(255,255,255,0.02)';ctx.strokeStyle='rgba(255,255,255,0.06)';ctx.lineWidth=1}ctx.fill();ctx.stroke();ctx.textAlign='center';ctx.textBaseline='middle';ctx.font='600 11px Gilroy,sans-serif';ctx.fillStyle=r.path==='dim'?'rgba(255,255,255,0.2)':r.path==='my'?'#ffffff':'rgba(255,255,255,0.7)';ctx.fillText(name,r.x+r.w/2,r.y+r.h/2);if(r.badge){ctx.font='800 11px PPNeueMachina,sans-serif';const txt=r.badge.toUpperCase();const bw=ctx.measureText(txt).width+16;const bx=r.x+r.w-bw-4,by=r.y-11;ctx.beginPath();ctx.rect(bx,by,bw,20);ctx.fillStyle=r.path==='my'?'#00e5ff':'#fbbf24';ctx.fill();ctx.fillStyle='#222222';ctx.textAlign='center';ctx.fillText(txt,bx+bw/2,by+10)}})});
}

function renderDemand(primaryKey,secondaryKey){
  const grid=document.getElementById('demandGrid');const primaryData=demandData[primaryKey]||demandData.graphic;const secondaryData=demandData[secondaryKey]||demandData.env;
  grid.innerHTML='<div class="demand-col"><div class="demand-col-label">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π ¬∑ '+clusterLabels[primaryKey]+'</div>'+primaryData.map(d=>dCard(d)).join('')+'</div><div class="demand-col"><div class="demand-col-label">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π ¬∑ '+clusterLabels[secondaryKey]+'</div>'+secondaryData.map(d=>dCard(d)).join('')+'</div>';
  setTimeout(()=>{document.querySelectorAll('.d-chart canvas').forEach(c=>{drawBarChart(c,JSON.parse(c.dataset.chart),JSON.parse(c.dataset.years),c.dataset.color)})},300);
}
function dCard(d){
  const hot=d.demand>=80?'hot':d.demand>=55?'warm':'';
  return '<div class="d-card"><div class="d-head"><div class="d-icon">'+d.icon+'</div><div class="d-title">'+d.title+'</div></div><div class="d-metrics"><div class="d-m"><div class="d-m-val '+hot+'">'+(d.vacancies/1000).toFixed(1)+'K</div><div class="d-m-label">–í–∞–∫–∞–Ω—Å–∏–π</div></div><div class="d-m"><div class="d-m-val">'+d.salary+'</div><div class="d-m-label">—Ç—ã—Å. ‚ÇΩ/–º–µ—Å</div></div><div class="d-m"><div class="d-m-val '+hot+'">'+d.demand+'%</div><div class="d-m-label">–°–ø—Ä–æ—Å</div></div></div><div class="d-chart"><canvas data-chart=\''+JSON.stringify(d.chart)+'\' data-years=\''+JSON.stringify(d.years)+'\' data-color="'+d.color+'"></canvas></div><div class="d-chips">'+d.skills.map(s=>'<span class="d-chip">'+s+'</span>').join('')+'</div><div class="d-trend '+d.trend+'">'+(d.trend==='up'?'‚Üë':'‚Üí')+' '+d.growth+' –∑–∞ –≥–æ–¥</div></div>';
}
function drawBarChart(canvas,data,years,color){
  const dpr=window.devicePixelRatio||1;const rect=canvas.parentElement.getBoundingClientRect();const W=rect.width-32,H=rect.height-32;
  canvas.width=W*dpr;canvas.height=H*dpr;canvas.style.width=W+'px';canvas.style.height=H+'px';
  const ctx=canvas.getContext('2d');ctx.scale(dpr,dpr);
  const n=data.length,barW=W/n*0.55;const gap2=(W-barW*n)/(n+1);const topPad=24,bottomPad=20;const max=Math.max(...data);const chartH=H-topPad-bottomPad;const baseY=topPad+chartH;
  const r=parseInt(color.slice(1,3),16),g=parseInt(color.slice(3,5),16),b=parseInt(color.slice(5,7),16);
  data.forEach((v,i)=>{const x=gap2+i*(barW+gap2);const h=(v/max)*chartH,y=baseY-h;const grad=ctx.createLinearGradient(x,y,x,baseY);if(i===n-1){grad.addColorStop(0,'rgba('+r+','+g+','+b+',0.7)');grad.addColorStop(1,'rgba('+r+','+g+','+b+',0.2)')}else{grad.addColorStop(0,'rgba('+r+','+g+','+b+',0.25)');grad.addColorStop(1,'rgba('+r+','+g+','+b+',0.05)')}ctx.fillStyle=grad;ctx.fillRect(x,y,barW,baseY-y);if(i===n-1){ctx.font='800 13px PPNeueMachina,sans-serif';ctx.fillStyle=color;ctx.textAlign='center';ctx.textBaseline='bottom';ctx.fillText((v/1000).toFixed(1)+'K',x+barW/2,y-4)}ctx.font='600 12px Gilroy,sans-serif';ctx.fillStyle=i===n-1?'rgba('+r+','+g+','+b+',0.8)':'rgba(255,255,255,0.2)';ctx.textAlign='center';ctx.textBaseline='top';ctx.fillText(years[i],x+barW/2,baseY+4)});
}

function shareResult(){if(tg){tg.close()}else{alert('–í Telegram ‚Äî –ø–æ–¥–µ–ª–∏—Å—å —Å—Å—ã–ª–∫–æ–π –Ω–∞ –±–æ—Ç–∞!')}}
</script>
</body>
</html>
